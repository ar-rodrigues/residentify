# Supabase Schema

| table_name               | column_name          | data_type                | is_nullable | column_default               | is_primary_key | referenced_table_name | referenced_column_name |
| ------------------------ | -------------------- | ------------------------ | ----------- | ---------------------------- | -------------- | --------------------- | ---------------------- |
| access_logs              | id                   | uuid                     | NO          | uuid_generate_v4()           | true           | null                  | null                   |
| access_logs              | qr_code_id           | uuid                     | NO          | null                         | false          | qr_codes              | id                     |
| access_logs              | scanned_by           | uuid                     | NO          | null                         | false          | null                  | null                   |
| access_logs              | organization_id      | uuid                     | NO          | null                         | false          | organizations         | id                     |
| access_logs              | entry_type           | USER-DEFINED             | NO          | null                         | false          | null                  | null                   |
| access_logs              | timestamp            | timestamp with time zone | YES         | now()                        | false          | null                  | null                   |
| organization_invitations | id                   | uuid                     | NO          | uuid_generate_v4()           | true           | null                  | null                   |
| organization_invitations | organization_id      | uuid                     | NO          | null                         | false          | organizations         | id                     |
| organization_invitations | email                | text                     | NO          | null                         | false          | null                  | null                   |
| organization_invitations | token                | text                     | NO          | null                         | false          | null                  | null                   |
| organization_invitations | invited_by           | uuid                     | NO          | null                         | false          | null                  | null                   |
| organization_invitations | status               | USER-DEFINED             | YES         | 'pending'::invitation_status | false          | null                  | null                   |
| organization_invitations | expires_at           | timestamp with time zone | NO          | null                         | false          | null                  | null                   |
| organization_invitations | created_at           | timestamp with time zone | YES         | now()                        | false          | null                  | null                   |
| organization_invitations | updated_at           | timestamp with time zone | YES         | now()                        | false          | null                  | null                   |
| organization_invitations | organization_role_id | integer                  | NO          | null                         | false          | organization_roles    | id                     |
| organization_members     | id                   | uuid                     | NO          | uuid_generate_v4()           | true           | null                  | null                   |
| organization_members     | user_id              | uuid                     | NO          | null                         | false          | null                  | null                   |
| organization_members     | organization_id      | uuid                     | NO          | null                         | false          | organizations         | id                     |
| organization_members     | invited_by           | uuid                     | YES         | null                         | false          | null                  | null                   |
| organization_members     | joined_at            | timestamp with time zone | YES         | now()                        | false          | null                  | null                   |
| organization_members     | created_at           | timestamp with time zone | YES         | now()                        | false          | null                  | null                   |
| organization_members     | updated_at           | timestamp with time zone | YES         | now()                        | false          | null                  | null                   |
| organization_members     | organization_role_id | integer                  | NO          | null                         | false          | organization_roles    | id                     |
| organization_roles       | id                   | integer                  | NO          | null                         | true           | null                  | null                   |
| organization_roles       | name                 | text                     | NO          | null                         | false          | null                  | null                   |
| organization_roles       | description          | text                     | YES         | null                         | false          | null                  | null                   |
| organization_roles       | created_at           | timestamp with time zone | YES         | now()                        | false          | null                  | null                   |
| organization_roles       | updated_at           | timestamp with time zone | YES         | now()                        | false          | null                  | null                   |
| organizations            | id                   | uuid                     | NO          | uuid_generate_v4()           | true           | null                  | null                   |
| organizations            | name                 | text                     | NO          | null                         | false          | null                  | null                   |
| organizations            | created_by           | uuid                     | NO          | null                         | false          | null                  | null                   |
| organizations            | created_at           | timestamp with time zone | YES         | now()                        | false          | null                  | null                   |
| organizations            | updated_at           | timestamp with time zone | YES         | now()                        | false          | null                  | null                   |
| profiles                 | id                   | uuid                     | NO          | null                         | true           | null                  | null                   |
| profiles                 | first_name           | text                     | NO          | null                         | false          | null                  | null                   |
| profiles                 | last_name            | text                     | NO          | null                         | false          | null                  | null                   |
| profiles                 | date_of_birth        | date                     | NO          | null                         | false          | null                  | null                   |
| profiles                 | role_id              | uuid                     | NO          | null                         | false          | roles                 | id                     |
| profiles                 | created_at           | timestamp with time zone | YES         | now()                        | false          | null                  | null                   |
| profiles                 | updated_at           | timestamp with time zone | YES         | now()                        | false          | null                  | null                   |
| qr_codes                 | id                   | uuid                     | NO          | uuid_generate_v4()           | true           | null                  | null                   |
| qr_codes                 | code                 | text                     | NO          | null                         | false          | null                  | null                   |
| qr_codes                 | organization_id      | uuid                     | NO          | null                         | false          | organizations         | id                     |
| qr_codes                 | created_by           | uuid                     | NO          | null                         | false          | null                  | null                   |
| qr_codes                 | visitor_name         | text                     | NO          | null                         | false          | null                  | null                   |
| qr_codes                 | visitor_email        | text                     | YES         | null                         | false          | null                  | null                   |
| qr_codes                 | visitor_phone        | text                     | YES         | null                         | false          | null                  | null                   |
| qr_codes                 | is_used              | boolean                  | YES         | false                        | false          | null                  | null                   |
| qr_codes                 | expires_at           | timestamp with time zone | NO          | null                         | false          | null                  | null                   |
| qr_codes                 | created_at           | timestamp with time zone | YES         | now()                        | false          | null                  | null                   |
| roles                    | id                   | uuid                     | NO          | uuid_generate_v4()           | true           | null                  | null                   |
| roles                    | name                 | text                     | NO          | null                         | false          | null                  | null                   |
| roles                    | description          | text                     | YES         | null                         | false          | null                  | null                   |
| roles                    | created_at           | timestamp with time zone | YES         | now()                        | false          | null                  | null                   |
| roles                    | updated_at           | timestamp with time zone | YES         | now()                        | false          | null                  | null                   |


## RLS Policies

| schemaname | tablename                | policyname                                                   | permissive | roles    | cmd    | qual                                                                                                                                                                                                                                                                                  | with_check                                                                                                                                                                                                                                                                                                                                                              |
| ---------- | ------------------------ | ------------------------------------------------------------ | ---------- | -------- | ------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| public     | access_logs              | Admins can view organization access logs                     | PERMISSIVE | {public} | SELECT | (EXISTS ( SELECT 1
   FROM (organization_members om
     JOIN organization_roles org_role ON ((om.organization_role_id = org_role.id)))
  WHERE ((om.organization_id = access_logs.organization_id) AND (om.user_id = auth.uid()) AND (org_role.name = 'admin'::text))))              | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | access_logs              | Residents can view own QR code access logs                   | PERMISSIVE | {public} | SELECT | (EXISTS ( SELECT 1
   FROM qr_codes
  WHERE ((qr_codes.id = access_logs.qr_code_id) AND (qr_codes.created_by = auth.uid()))))                                                                                                                                                         | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | access_logs              | Security can create access logs                              | PERMISSIVE | {public} | INSERT | null                                                                                                                                                                                                                                                                                  | ((auth.uid() = scanned_by) AND (EXISTS ( SELECT 1
   FROM (organization_members om
     JOIN organization_roles org_role ON ((om.organization_role_id = org_role.id)))
  WHERE ((om.organization_id = access_logs.organization_id) AND (om.user_id = auth.uid()) AND (org_role.name = 'security_personnel'::text)))))                                                   |
| public     | access_logs              | Security can view organization access logs                   | PERMISSIVE | {public} | SELECT | (EXISTS ( SELECT 1
   FROM (organization_members om
     JOIN organization_roles org_role ON ((om.organization_role_id = org_role.id)))
  WHERE ((om.organization_id = access_logs.organization_id) AND (om.user_id = auth.uid()) AND (org_role.name = 'security_personnel'::text)))) | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | organization_invitations | Admins can create invitations                                | PERMISSIVE | {public} | INSERT | null                                                                                                                                                                                                                                                                                  | ((auth.uid() = invited_by) AND (EXISTS ( SELECT 1
   FROM (organization_members om
     JOIN organization_roles org_role ON ((om.organization_role_id = org_role.id)))
  WHERE ((om.organization_id = organization_invitations.organization_id) AND (om.user_id = auth.uid()) AND (org_role.name = 'admin'::text)))))                                                   |
| public     | organization_invitations | Admins can delete invitations                                | PERMISSIVE | {public} | DELETE | (EXISTS ( SELECT 1
   FROM (organization_members om
     JOIN organization_roles org_role ON ((om.organization_role_id = org_role.id)))
  WHERE ((om.organization_id = organization_invitations.organization_id) AND (om.user_id = auth.uid()) AND (org_role.name = 'admin'::text)))) | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | organization_invitations | Admins can update invitations                                | PERMISSIVE | {public} | UPDATE | (EXISTS ( SELECT 1
   FROM (organization_members om
     JOIN organization_roles org_role ON ((om.organization_role_id = org_role.id)))
  WHERE ((om.organization_id = organization_invitations.organization_id) AND (om.user_id = auth.uid()) AND (org_role.name = 'admin'::text)))) | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | organization_invitations | Admins can view organization invitations                     | PERMISSIVE | {public} | SELECT | (EXISTS ( SELECT 1
   FROM (organization_members om
     JOIN organization_roles org_role ON ((om.organization_role_id = org_role.id)))
  WHERE ((om.organization_id = organization_invitations.organization_id) AND (om.user_id = auth.uid()) AND (org_role.name = 'admin'::text)))) | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | organization_invitations | Users can view own invitations                               | PERMISSIVE | {public} | SELECT | ((email = (( SELECT users.email
   FROM auth.users
  WHERE (users.id = auth.uid())))::text) AND (status = 'pending'::invitation_status))                                                                                                                                              | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | organization_members     | Admins can add organization members                          | PERMISSIVE | {public} | INSERT | null                                                                                                                                                                                                                                                                                  | (EXISTS ( SELECT 1
   FROM (organization_members om
     JOIN organization_roles org_role ON ((om.organization_role_id = org_role.id)))
  WHERE ((om.organization_id = organization_members.organization_id) AND (om.user_id = auth.uid()) AND (org_role.name = 'admin'::text))))                                                                                       |
| public     | organization_members     | Admins can remove organization members                       | PERMISSIVE | {public} | DELETE | (EXISTS ( SELECT 1
   FROM (organization_members om
     JOIN organization_roles org_role ON ((om.organization_role_id = org_role.id)))
  WHERE ((om.organization_id = organization_members.organization_id) AND (om.user_id = auth.uid()) AND (org_role.name = 'admin'::text))))     | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | organization_members     | Admins can update member roles                               | PERMISSIVE | {public} | UPDATE | (EXISTS ( SELECT 1
   FROM (organization_members om
     JOIN organization_roles org_role ON ((om.organization_role_id = org_role.id)))
  WHERE ((om.organization_id = organization_members.organization_id) AND (om.user_id = auth.uid()) AND (org_role.name = 'admin'::text))))     | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | organization_members     | Users can add themselves as admin when creating organization | PERMISSIVE | {public} | INSERT | null                                                                                                                                                                                                                                                                                  | ((auth.uid() = user_id) AND (EXISTS ( SELECT 1
   FROM organizations
  WHERE ((organizations.id = organization_members.organization_id) AND (organizations.created_by = auth.uid())))) AND (EXISTS ( SELECT 1
   FROM organization_roles
  WHERE ((organization_roles.id = organization_members.organization_role_id) AND (organization_roles.name = 'admin'::text))))) |
| public     | organization_members     | Users can leave organization                                 | PERMISSIVE | {public} | DELETE | (auth.uid() = user_id)                                                                                                                                                                                                                                                                | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | organization_members     | Users can view organization members                          | PERMISSIVE | {public} | SELECT | is_user_organization_member(auth.uid(), organization_id)                                                                                                                                                                                                                              | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | organization_members     | Users can view own memberships                               | PERMISSIVE | {public} | SELECT | (auth.uid() = user_id)                                                                                                                                                                                                                                                                | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | organization_roles       | Everyone can read organization roles                         | PERMISSIVE | {public} | SELECT | true                                                                                                                                                                                                                                                                                  | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | organizations            | Organization admins can delete organization                  | PERMISSIVE | {public} | DELETE | (EXISTS ( SELECT 1
   FROM (organization_members om
     JOIN organization_roles org_role ON ((om.organization_role_id = org_role.id)))
  WHERE ((om.organization_id = organizations.id) AND (om.user_id = auth.uid()) AND (org_role.name = 'admin'::text))))                         | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | organizations            | Organization admins can update organization                  | PERMISSIVE | {public} | UPDATE | (EXISTS ( SELECT 1
   FROM (organization_members om
     JOIN organization_roles org_role ON ((om.organization_role_id = org_role.id)))
  WHERE ((om.organization_id = organizations.id) AND (om.user_id = auth.uid()) AND (org_role.name = 'admin'::text))))                         | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | organizations            | Users can create organizations                               | PERMISSIVE | {public} | INSERT | null                                                                                                                                                                                                                                                                                  | (auth.uid() = created_by)                                                                                                                                                                                                                                                                                                                                               |
| public     | organizations            | Users can view organizations they belong to                  | PERMISSIVE | {public} | SELECT | (EXISTS ( SELECT 1
   FROM organization_members
  WHERE ((organization_members.organization_id = organizations.id) AND (organization_members.user_id = auth.uid()))))                                                                                                                 | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | profiles                 | Users can insert own profile                                 | PERMISSIVE | {public} | INSERT | null                                                                                                                                                                                                                                                                                  | (auth.uid() = id)                                                                                                                                                                                                                                                                                                                                                       |
| public     | profiles                 | Users can update own profile                                 | PERMISSIVE | {public} | UPDATE | (auth.uid() = id)                                                                                                                                                                                                                                                                     | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | profiles                 | Users can view own profile                                   | PERMISSIVE | {public} | SELECT | (auth.uid() = id)                                                                                                                                                                                                                                                                     | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | qr_codes                 | Admins can view organization QR codes                        | PERMISSIVE | {public} | SELECT | (EXISTS ( SELECT 1
   FROM (organization_members om
     JOIN organization_roles org_role ON ((om.organization_role_id = org_role.id)))
  WHERE ((om.organization_id = qr_codes.organization_id) AND (om.user_id = auth.uid()) AND (org_role.name = 'admin'::text))))                 | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | qr_codes                 | Residents can create QR codes                                | PERMISSIVE | {public} | INSERT | null                                                                                                                                                                                                                                                                                  | ((auth.uid() = created_by) AND (EXISTS ( SELECT 1
   FROM (organization_members om
     JOIN organization_roles org_role ON ((om.organization_role_id = org_role.id)))
  WHERE ((om.organization_id = qr_codes.organization_id) AND (om.user_id = auth.uid()) AND (org_role.name = 'resident'::text)))))                                                                |
| public     | qr_codes                 | Residents can update own QR codes                            | PERMISSIVE | {public} | UPDATE | ((auth.uid() = created_by) AND (is_used = false))                                                                                                                                                                                                                                     | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | qr_codes                 | Residents can view own QR codes                              | PERMISSIVE | {public} | SELECT | (auth.uid() = created_by)                                                                                                                                                                                                                                                             | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | qr_codes                 | Security can mark QR codes as used                           | PERMISSIVE | {public} | UPDATE | (EXISTS ( SELECT 1
   FROM (organization_members om
     JOIN organization_roles org_role ON ((om.organization_role_id = org_role.id)))
  WHERE ((om.organization_id = qr_codes.organization_id) AND (om.user_id = auth.uid()) AND (org_role.name = 'security_personnel'::text))))    | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | qr_codes                 | Security can view organization QR codes                      | PERMISSIVE | {public} | SELECT | (EXISTS ( SELECT 1
   FROM (organization_members om
     JOIN organization_roles org_role ON ((om.organization_role_id = org_role.id)))
  WHERE ((om.organization_id = qr_codes.organization_id) AND (om.user_id = auth.uid()) AND (org_role.name = 'security_personnel'::text))))    | null                                                                                                                                                                                                                                                                                                                                                                    |
| public     | roles                    | Everyone can read roles                                      | PERMISSIVE | {public} | SELECT | true                                                                                                                                                                                                                                                                                  | null                                                                                                                                                                                                                                                                                                                                                                    |