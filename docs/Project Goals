# Project Goals

## Overview

A building access management system where organizations can manage residents, security personnel, and visitor access through QR codes.

## Core Features

### User Registration & Organization Management

- Users can register and create an organization
- Organization creators automatically receive the **Admin** role
- Admins can invite new users to their organization and assign roles

## Role Architecture

The system uses a **two-tier role system**:

### App-Level Roles

- **Purpose**: Control access to application-wide features
- **Scope**: Applies to the entire application
- **Examples**: `user`, `super_admin` (if needed)
- **Storage**: `profiles.role_id` references `roles.id`
- **Note**: A user has **one** app-level role

### Organization-Level Roles

- **Purpose**: Control access within specific organizations
- **Scope**: Applies only within a specific organization
- **Examples**: `admin`, `resident`, `security_personnel`
- **Storage**: `organization_members.organization_role_id` references `organization_roles.id` (table-based, not enum)
- **Note**: A user can have **different roles in different organizations**

### Multi-Organization Support

- Users can belong to **multiple organizations**
- Each organization membership has its own role
- A user can be an Admin in Organization A and a Resident in Organization B
- When accessing organization-specific features, the system checks the user's role **in that specific organization**

## User Roles

### App-Level Roles

#### 1. User (Default)

- **Who**: All registered users
- **Permissions**:
  - Access the application
  - Create organizations
  - Join organizations via invitation
  - Manage own profile

### Organization-Level Roles

#### 1. Admin (Organization-Level)

- **Who**: Organization creators and assigned admins
- **Scope**: Specific organization only
- **Permissions**:
  - Manage organization settings
  - Invite users to the organization
  - Assign/change roles to organization members
  - Remove members from organization
  - Full access to organization management
  - View all access logs for the organization

#### 2. Resident (Organization-Level)

- **Who**: People living in an apartment building
- **Scope**: Specific organization only
- **Permissions**:
  - Invite external visitors (people outside the app)
  - Generate QR codes for external visitors
  - View their own visitor history (QR codes they generated)
  - View access logs for their own QR codes

#### 3. Security Personnel (Organization-Level)

- **Who**: People responsible for securing the building entrance
- **Scope**: Specific organization only
- **Permissions**:
  - Scan QR codes of all users (residents, external visitors, etc.)
  - Register entries and exits
  - Monitor who enters and leaves the building
  - View all access logs for the organization
  - View visitor information on scan

#### 4. External Visitor

- **Who**: People invited by residents (not registered in the app)
- **Access**:
  - Receive one-time QR codes from residents
  - Use QR code to enter the building
  - QR code registers their entrance automatically
  - **Note**: Not a role, but a visitor type tracked via QR codes

## User Flows

### Flow 1: Organization Setup

1. User registers in the system → receives app-level role "user"
2. User creates an organization → automatically becomes **Admin** in that organization (organization-level role)
3. Admin invites users (Residents, Security Personnel) and assigns organization-level roles
4. Invited users can accept and join the organization with their assigned role
5. Users can belong to multiple organizations with different roles in each

### Flow 2: Resident Invites Visitor

1. Resident generates a QR code for an external visitor
2. External visitor receives the one-time QR code
3. Visitor presents QR code at entrance

### Flow 3: Access Control

1. Security Personnel scans QR code at entrance
2. System validates QR code and registers entry/exit
3. Access log is recorded with timestamp and visitor information

## Technical Requirements

- QR code generation for external visitors (one-time use)
- QR code scanning capability for Security Personnel
- Entry/exit logging system
- Two-tier role-based access control (RBAC):
  - App-level roles (user profile)
  - Organization-level roles (organization membership)
- Organization-based multi-tenancy
- Multi-organization support (users can belong to multiple organizations)
- Organization context switching (users select which organization they're working with)

## Implementation Features

### Phase 1: Foundation & Authentication

#### 1.1 User Authentication

- [x] User registration (email, password, name, date_of_birth)
- [x] User login/logout
- [x] Password reset functionality
- [ ] Email verification
- [x] Session management
- [x] Protected routes middleware

#### 1.2 Database Schema

- [x] Users table (via Supabase auth.users)
- [x] Profiles table (id, first_name, last_name, date_of_birth, role_id, created_at, updated_at)
- [x] App-level roles table (id, name, description, created_at, updated_at)
- [x] Organizations table (id, name, created_by, created_at, updated_at)
- [x] Organization members table (id, user_id, organization_id, organization_role_id, invited_by, joined_at, created_at, updated_at)
- [x] Organization roles table (id, name, description, created_at, updated_at) - stores admin, resident, security_personnel
- [x] QR codes table (id, code, organization_id, created_by, visitor_name, visitor_email, visitor_phone, is_used, expires_at, created_at)
- [x] Access logs table (id, qr_code_id, scanned_by, organization_id, entry_type, timestamp)
- [x] Organization invitations table (id, organization_id, email, token, organization_role_id, invited_by, status, expires_at, created_at, updated_at)
- [x] Database function: `create_organization_with_admin` - atomically creates organization and adds creator as admin
- [x] Database function: `get_user_name` - gets user name bypassing RLS for organization creator display
- [x] Database function: `is_user_organization_member` - checks membership without RLS recursion
- [x] Database function: `create_organization_invitation` - atomically creates invitation with duplicate checking
- [x] Database function: `get_invitation_by_token` - gets invitation by token bypassing RLS for public access

### Phase 2: Organization Management

**Note**: API routes and custom hooks have been implemented:

- [x] API route: `POST /api/organizations` - Create organization
- [x] API route: `GET /api/organizations/[id]` - Get organization details
- [x] API route: `PUT /api/organizations/[id]` - Update organization (admin only)
- [x] API route: `POST /api/organizations/[id]/invitations` - Create invitation (admin only)
- [x] API route: `GET /api/organization-roles` - Get all organization roles
- [x] API route: `GET /api/invitations/[token]` - Get invitation by token (public)
- [x] API route: `POST /api/invitations/[token]/accept` - Accept invitation (new user registration)
- [x] API route: `POST /api/invitations/[token]/accept-logged-in` - Accept invitation (logged-in user)
- [x] API route: `GET /api/invitations/[token]/check-email` - Check email status for invitation
- [x] Custom hook: `useOrganizations` - Provides organization CRUD operations and state management
- [x] Custom hook: `useInvitations` - Provides invitation operations (create, get, accept, check email)

#### 2.1 Organization Creation

- [x] Create organization form/page
- [x] Organization name validation (min 2, max 100 characters, required)
- [x] Auto-assign organization-level admin role to creator (via `create_organization_with_admin` function)
- [x] Organization detail page/view
- [x] Edit organization page (`/organizations/[id]/edit`)
- [ ] Organization dashboard/overview (full dashboard with stats)
- [ ] Organization selector/switcher (for users in multiple organizations)
- [ ] Set active organization context
- [ ] Store active organization in session/state

#### 2.4 Organization Context Management

- [ ] Organization context provider/hook
- [x] Get user's organizations list (via `useOrganizations` hook)
- [x] Get user's role in specific organization (via API and hook)
- [ ] Switch active organization
- [ ] Persist active organization selection
- [x] Validate user has access to selected organization (RLS policies enforce this)
- [ ] Display organization name in header/navigation

#### 2.2 Organization Settings

- [x] View organization details (shows name, created date, creator, user role)
- [x] Edit organization name (admin only, with validation)
- [x] Edit organization page with form validation
- [x] Admin-only access control for edit functionality
- [ ] View organization members list (placeholder exists)
- [ ] Delete organization (admin only)

#### 2.3 User Invitations

- [x] Send invitation email to new users (via email service)
- [x] Invitation link with secure token generation
- [x] Invite user page (`/organizations/[id]/invite`) with form validation
- [x] Accept invitation flow (public page at `/invitations/[token]`)
- [x] Accept invitation for new users (registration flow)
- [x] Accept invitation for logged-in users (direct acceptance)
- [x] Email verification for invitation acceptance
- [x] Assign organization role during invitation (admin, resident, security_personnel)
- [x] Invitation expiration handling (7 days default, validated on acceptance)
- [x] Prevent duplicate invitations (same user + organization, handled by database function)
- [x] Invitation status tracking (pending, accepted, cancelled)
- [x] Admin-only access control for invitation creation
- [ ] Resend invitation
- [ ] Cancel pending invitation

### Phase 3: Role Management

#### 3.1 Organization Role Assignment

- [x] Assign organization role to member during invitation (admin only)
- [x] Organization roles API endpoint for role selection
- [ ] Change member's organization role (admin only)
- [ ] Remove member from organization (admin only)
- [x] Role-based UI visibility (based on organization role) - Admin buttons shown conditionally
- [x] Validate user has required organization role for actions - Implemented in API routes and UI

#### 3.2 Role Permissions

- [x] Permission checks in API routes (check organization role) - Admin checks in PUT and invitation endpoints
- [x] Permission checks in frontend components (check organization role) - Implemented in organization detail and invite pages
- [x] Admin-only features protection (organization-level) - Edit and invite features protected
- [ ] Permission middleware for API routes (reusable middleware pattern)
- [ ] Organization context selection (user selects active organization)
- [ ] Resident-only features protection (organization-level)
- [ ] Security Personnel-only features protection (organization-level)
- [x] Helper functions to check user's role in specific organization - Via API and hook (isAdmin, userRole)

### Phase 4: QR Code System

#### 4.1 QR Code Generation (Resident)

- [ ] Generate QR code form (visitor name, email, phone, expiration date)
- [ ] QR code generation API endpoint
- [ ] QR code display/download
- [ ] Share QR code (email, SMS, copy link)
- [ ] QR code expiration validation

#### 4.2 QR Code Management

- [ ] View all generated QR codes (resident)
- [ ] View QR code details
- [ ] Revoke unused QR code
- [ ] QR code usage status (used/unused/expired)
- [ ] QR code history/filtering

#### 4.3 QR Code Validation

- [ ] QR code validation API
- [ ] Check if QR code is valid (not used, not expired)
- [ ] Mark QR code as used after scan
- [ ] Return visitor information on validation

### Phase 5: Access Control & Scanning

#### 5.1 QR Code Scanner (Security Personnel)

- [ ] Camera-based QR code scanner component
- [ ] Manual QR code input (fallback)
- [ ] Scanner UI for security personnel
- [ ] Real-time validation feedback

#### 5.2 Entry/Exit Registration

- [ ] Register entry (scan QR code)
- [ ] Register exit (scan QR code)
- [ ] Entry/exit toggle functionality
- [ ] Success/error notifications
- [ ] Visitor information display on scan

#### 5.3 Access Logs

- [ ] Create access log entry on scan
- [ ] Store entry/exit type
- [ ] Link to QR code and scanner user
- [ ] Timestamp recording

### Phase 6: Dashboard & Views

#### 6.1 Admin Dashboard

- [ ] Organization overview statistics
- [ ] Recent activity feed
- [ ] Member management interface
- [ ] Access logs overview
- [ ] Pending invitations list

#### 6.2 Resident Dashboard

- [ ] Quick QR code generation
- [ ] Recent QR codes list
- [ ] Visitor history (QR codes generated)
- [ ] Active/expired QR codes status

#### 6.3 Security Personnel Dashboard

- [ ] Quick scanner access
- [ ] Recent scans list
- [ ] Today's entries/exits summary
- [ ] Access logs view with filters

#### 6.4 Access Logs View

- [ ] View all access logs (security personnel, admin)
- [ ] Filter by date range
- [ ] Filter by entry/exit type
- [ ] Filter by visitor name
- [ ] Export logs (CSV/PDF)
- [ ] Search functionality

### Phase 7: External Visitor Experience

#### 7.1 QR Code Reception

- [ ] Email/SMS with QR code image
- [ ] QR code landing page (public)
- [ ] QR code download instructions
- [ ] QR code expiration information

#### 7.2 Visitor Information

- [ ] Display visitor name on QR code
- [ ] QR code validity status
- [ ] Instructions for use

### Phase 8: Additional Features

#### 8.1 Notifications

- [x] Email notifications for invitations (invitation email sent with link and details)
- [ ] Email notifications for QR code generation
- [ ] In-app notifications for access events
- [ ] Notification preferences

#### 8.2 Profile Management

- [x] User profile page
- [x] Edit profile information (first_name, last_name, date_of_birth)
- [x] Change password
- [x] Change email
- [ ] View organization memberships
- [ ] Switch between organizations (organization selector)
- [ ] Leave organization

#### 8.3 Security & Validation

- [ ] QR code encryption/security
- [ ] Rate limiting on QR code generation
- [ ] Rate limiting on QR code scans
- [ ] Input validation and sanitization
- [ ] Error handling and logging

#### 8.4 Mobile Responsiveness

- [ ] Mobile-friendly scanner
- [ ] Responsive dashboards
- [ ] Mobile QR code generation
- [ ] Touch-optimized UI

### Phase 9: Testing & Polish

#### 9.1 Testing

- [ ] Unit tests for core functions
- [ ] Integration tests for API endpoints
- [ ] E2E tests for critical flows
- [ ] QR code validation tests
- [ ] Role permission tests

#### 9.2 UI/UX Improvements

- [ ] Loading states
- [ ] Error messages
- [ ] Success confirmations
- [ ] Empty states
- [ ] Accessibility improvements
